# ERC-8004 Research

## Overview
ERC-8004 "Trustless Agents" — an on-chain identity and discovery protocol for AI agents using ERC-721 NFT registries.

## Status
- Draft (created 2025-08-13)
- Authors: Marco De Rossi (MetaMask), Davide Crapis (Ethereum Foundation), Jordan Ellis (Google), Erik Reppel (Coinbase)
- Forum: https://ethereum-magicians.org/t/erc-8004-trustless-agents/25098

## Three Registries

### 1. Identity Registry (ERC-721)
- Each agent gets a tokenId (agentId) 
- Owner = the agent's operator wallet
- Token URI = agentURI → resolves to registration JSON

### 2. Reputation Registry
- Post/fetch feedback signals about agents
- Scoring on-chain (for composability) + off-chain (for sophisticated algorithms)
- Payment receipts (x402) can enrich feedback

### 3. Validation Registry
- Hooks for independent validator checks (stakers re-running jobs, zkML, TEE oracles)

## Identity Registry ABI (Key Functions)
```solidity
// Registration
function register(string agentURI) external returns (uint256 agentId)
function register(string agentURI, string[] metadataKeys, bytes[] metadataValues) external returns (uint256)
function setAgentURI(uint256 agentId, string newURI) external

// ERC-721 standard
function balanceOf(address owner) view returns (uint256)
function ownerOf(uint256 tokenId) view returns (address)
function tokenURI(uint256 tokenId) view returns (string)

// Payment wallet
function setAgentWallet(uint256 agentId, address newWallet, uint256 deadline, bytes signature) external
function getAgentWallet(uint256 agentId) external view returns (address)
function unsetAgentWallet(uint256 agentId) external

// Metadata
function getMetadata(uint256 agentId, string metadataKey) external view returns (bytes)
function setMetadata(uint256 agentId, string metadataKey, bytes metadataValue) external
```

## Contract Addresses
- **Same address on all supported chains**: `0x8004A169FB4a3325136EB29fA0ceB6D2e539a432`
  - Vanity address mirroring EIP-8004
  - **Verified on-chain**: has bytecode on Base and Ethereum mainnet
  - `0xd1fF2B5015C1C4489fBb2Ea2a3811Dbd5D789E02` (from EIP spec text) has NO code deployed — do NOT use
  - Deployed on 16+ chains including Base, Ethereum, Polygon, Arbitrum, etc.

## Agent Registration File Format
```json
{
  "type": "https://eips.ethereum.org/EIPS/eip-8004#registration-v1",
  "name": "AgentName",
  "description": "Natural language description...",
  "image": "https://example.com/agent.png",
  "services": [
    { "name": "MCP", "endpoint": "https://mcp.agent.eth/", "version": "2025-06-18" },
    { "name": "A2A", "endpoint": "https://agent.example/.well-known/agent-card.json", "version": "0.3.0" },
    { "name": "web", "endpoint": "https://agent.example/" }
  ],
  "x402Support": true,
  "active": true,
  "registrations": [
    { "agentId": 22, "agentRegistry": "eip155:8453:0x8004A169FB4a3325136EB29fA0ceB6D2e539a432" }
  ],
  "supportedTrust": ["reputation", "crypto-economic"]
}
```

## Our Registration (Arca)
- agentId: 2376 (Base)
- Registry: `0x8004A169FB4a3325136EB29fA0ceB6D2e539a432` (confirmed on-chain)
- Wallet: Set via `PRIVATE_KEY` env var
- Registered on 16 chains as of last check

## Global Agent ID Format
```
{namespace}:{chainId}:{identityRegistry}#{agentId}
// e.g. eip155:8453:0x8004A169FB4a3325136EB29fA0ceB6D2e539a432#2376
```

## Verification Flow
1. Look up agent by global ID → get tokenURI
2. Fetch registration file at tokenURI
3. Verify `registrations` array includes a back-reference to this chain's registry + agentId
4. (Optional) Check endpoint domain verification via `.well-known/agent-registration.json`
5. (Optional) Check reputation/validation registries

## Discovery
- No built-in discovery (it's a registry, not a directory)
- Off-chain indexers needed for capability-based search
- The `services` array is the key for MCP/A2A endpoint resolution
- The `description` field enables semantic search

## No Existing SDK
- No official SDK exists for ERC-8004 as of Feb 2026
- Coinbase co-authored but no @coinbase/erc8004 package found
- Our scripts are among the first real-world implementations
